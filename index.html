<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1 Tiny//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11-tiny.dtd">
<html lang="en">
	<head>
		<title>Fish bursting game</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style type="text/css">
			body {
				margin: 0px;
				overflow: hidden;
			}

			.parallax {
				position : absolute;
				display : block; 
				width : 256px; 
				height : 384px;
				-webkit-transform-origin : 0px 0px;
				-moz-transform-origin : 0px 0px;
				-ms-transform-origin : 0px 0px;
				-o-transform-origin : 0px 0px;
				transform-origin : 0px 0px;
			}
			.background {
				
				position : absolute; 
				display : block; 
				-webkit-transform-style: preserve-3d;
				-webkit-transform : translateZ(0px);
				-moz-transform : translateZ(0px);
				-moz-transform-style: preserve-3d;
				-o-transform : translateZ(0px);
				-o-transform-style: preserve-3d;
				transform : translateZ(0px);
				transform-style: preserve-3d; 

				overflow : hidden;
				pointer-events :none;
			}
			.container {
				
				position : absolute; 
				display : block; 
				-webkit-transform-style: preserve-3d;
				-webkit-transform : translateZ(0px);
				-moz-transform : translateZ(0px);
				-moz-transform-style: preserve-3d;
				-o-transform : translateZ(0px);
				-o-transform-style: preserve-3d;
				transform : translateZ(0px);
				transform-style: preserve-3d; 

				overflow : hidden;
				pointer-events :none;
			}

			.info {
				position : absolute;
				display : block; 
				color : #ffffff;
				-webkit-transform-origin : 0px 0px;
				-moz-transform-origin : 0px 0px;
				-ms-transform-origin : 0px 0px;
				-o-transform-origin : 0px 0px;
				transform-origin : 0px 0px;
			}

			.svg {
				position : absolute;
				display : block; 
				width : 256px; 
				height : 20px; 
			}
		
		</style>
	</head>
	<body>
		<script type="text/javascript" src="js/Fish.js"></script>
		<script type="text/javascript" src="js/Particles.js"></script>
		<script type="text/javascript" src="js/MathTools.js"></script>
		<script type="text/javascript" >
		
			
			// DOM elements
			var browser = navigator.appName.toLowerCase();
			var xmlns = "http://www.w3.org/2000/svg";
			var tools = new MathTools();
			var background = document.createElement('div');
			var container =	document.createElement('div'),

				layer1 = document.createElement('div'),
				layer2 = document.createElement('div'),
				info = document.createElement('div'),
				info2 = document.createElement('div'),
				svg =  document.createElementNS (xmlns, "svg"),

			// screen size variables
				SCREEN_WIDTH = 768,
				SCREEN_HEIGHT = 576,
				HALF_WIDTH = SCREEN_WIDTH / 2,
				HALF_HEIGHT = SCREEN_HEIGHT / 2,

			// fish variables
				fishes = [],
				spareFishes = [],
	
				counter = 0, 
				burstSound, 
 
			// the particle emitter
			 	emitter = new Emitter(container); 
	
		
			initSounds(); 	
			
			// set up the CSS for the DOM elements
			layer1.className = "parallax"; 
			layer1.style.background = 'url(img/parallaxBack.jpg)'; 
			/*layer1.style.width = SCREEN_WIDTH+"px";
			layer1.style.height = SCREEN_HEIGHT+"px";
			layer1.style.position = 'absolute';
			layer1.style.display = 'block';*/
			
			//document.body.appendChild(layer1); 

			layer2.className = "parallax"; 
			layer2.style.background = 'url(img/parallaxFront.png) transparent'; 
			//layer2.style.width = SCREEN_WIDTH+"px";
			//layer2.style.height = SCREEN_HEIGHT+"px";
			//document.body.appendChild(layer2); 

			background.className = "background"; 
			background.style.webkitPerspective= "400";
			background.style.webkitPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";
			
			background.style.MozPerspective= "400";
			background.style.MozPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";

			background.style.oPerspective= "400";
			background.style.oPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";

			background.style.perspective= "400";
			background.style.perspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";


			background.style.width = SCREEN_WIDTH; 
			background.style.height = SCREEN_HEIGHT; 
			background.style.top = '20px'; 
			background.style.left = '20px';

			document.body.appendChild(background);
			background.appendChild(layer1); 
			background.appendChild(layer2);

			container.className = "container"; 
			container.style.webkitPerspective= "400";
			container.style.webkitPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";
			
			container.style.MozPerspective= "400";
			container.style.MozPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";

			container.style.oPerspective= "400";
			container.style.oPerspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";

			container.style.perspective= "400";
			container.style.perspectiveOrigin= HALF_WIDTH+"px "+HALF_HEIGHT+"px";


			container.style.width = SCREEN_WIDTH; 
			container.style.height = SCREEN_HEIGHT; 
			container.style.top = '20px'; 
			container.style.left = '20px';

			document.body.appendChild(container); 
			
			//window.addEventListener("load", init); 

			info.className = "info"; 
			info.innerHTML =  browser; //+ ' '+ version; 
			info.style.top = '20px'; 
			info.style.left = '40px';
			document.body.appendChild(info); 

			info2.className = "info"; 
			info2.style.top = '80px'; 
			info2.style.left = '40px';
			document.body.appendChild(info2); 

			svg.className = "svg";
			info.appendChild(svg);
			

			// "circle" may be any tag name
			var shape = document.createElementNS(xmlns, "circle");
			// Set any attributes as desired
			shape.setAttribute("cx", 25);
			shape.setAttribute("cy", 25);
			shape.setAttribute("r",  20);
			shape.setAttribute("fill", "red");
			svg.appendChild(shape);

			function init() {
				detectOrientation();
				initMouseListeners(); 
				setInterval(gameLoop, 1000/60); 
			}
			
			function gameLoop() {

				// every 20 frames, make a new fish
				if(counter++%20==0)
					makeFish();	
	
				// update the parallax layers
				//layer1.style.webkitTransform = "translate3d(0px, "+(-768 +((counter*5)%768))+"px, -999px) scale(4)"; 				
				//layer2.style.webkitTransform  = "translate3d(0px, "+(-768 +((counter*10)%768))+"px, -998px) scale(4)"; 

				layer1.style.webkitTransform = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*5)%SCREEN_HEIGHT))+"px, -2px) scale(3)"; 				
				layer2.style.webkitTransform  = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*10)%SCREEN_HEIGHT))+"px, -2px) scale(3)"; 

				layer1.style.MozTransform = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*5)%SCREEN_HEIGHT))+"px, -1px) scale(3)"; 				
				layer2.style.MozTransform  = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*10)%SCREEN_HEIGHT))+"px, -1px) scale(3)"; 

				//layer1.style.MSTransform = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*5)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 				
				//layer2.style.MSTransform  = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*10)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 

				layer1.style.OTransform = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*5)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 				
				layer2.style.OTransform  = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*10)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 

				layer1.style.transform = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*5)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 				
				layer2.style.transform  = "translate3d(0px, "+(-SCREEN_HEIGHT +((counter*10)%SCREEN_HEIGHT))+"px, 0px) scale(3)"; 
	 
	 
			  	// iteratate through each fish
				for (i=0; i<fishes.length; i++) {
					var fish = fishes[i]; 
					if(!fish.enabled) continue; 
		
					// update the fishes position properties
					fish.update();
		
					// and then update the visible object for that fish
					fish.render(); 
	
					// if the fish is way off the top of the screen, then 
					// remove it. For the finished game you would probably 
					// add some kind of score penalty at this point. 
					if(fish.posY <-200) removeFish(fish); 
		
				}

				// then update all the particles. 
				emitter.update(); 

			}
			
			function makeFish() {
				var fish;
				
				// create a new fish in the bottom middle of the stage
				if(spareFishes.length>0) {
					// if one is already in the spare array, recycle it
					fish = spareFishes.pop(); 	
					fish.enabled = true; 
					fish.domElement.style.visibility = "visible"; 
				} else {
					// otherwise make a new one
					// Work out the fishimage URL 
					var fishImageURL = "img/orangefish0"+((fishes.length % 4) + 1)+".png"; 
					// and then make a new fish object
					fish = new Fish(0, 0, 0, fishImageURL, 128, 128); 
					// add it into the array of fishes
					fishes.push(fish); 
	
					// then add touch and mousedown events to the fish. 
					fish.domElement.addEventListener("mouseover", fishMouseOver, true); 
					fish.domElement.addEventListener("touchstart", fishTouched, true); 
	
					container.appendChild(fish.domElement);
				}
				
				fish.posX = HALF_WIDTH + tools.randomRange(-250,250); 
				fish.posY = SCREEN_HEIGHT+100;
				fish.posZ = tools.randomRange(-250,250);

				// give it a random x and y velocity
				fish.velX = tools.randomRange(-1,1);
				fish.velY = tools.randomRange(-1,-2);
				fish.velZ = tools.randomRange(-1,1);

				fish.size = 1;
				fish.gravity = -0.05; 
		
			}
			
			function removeFish(fish) {
				fish.enabled = false; 
				fish.domElement.style.visibility = "hidden"; 
				spareFishes.push(fish);
			}
	
			function fishMouseOver(event) {
				event.preventDefault(); 
				var fish = getFishFromElement(event.target); 
				if(fish) explodeFish(fish); 
			}

			function fishTouched(event) {
				event.preventDefault(); 
				for(var j=0; j<event.changedTouches.length; j++) {
					var fish = getFishFromElement(event.target); 
					if(fish) explodeFish(fish); 
				}
			}
	
			function getFishFromElement(domElement) {
				for(var i=0; i<fishes.length;i++) {
					if(fishes[i].domElement == domElement) return fishes[i]; 
				}
				return false; 
			}	

			function explodeFish(fish) {
				playBurst(); 
				emitter.makeExplosion(fish.posX, fish.posY, fish.posZ); 
				removeFish(fish);
			}
				
			function initMouseListeners() {
				document.addEventListener('mousemove', preventDefault, false);
				document.addEventListener( 'mousedown', preventDefault, false );
				document.addEventListener( 'mouseup', preventDefault, false );
				document.addEventListener( 'touchstart', preventDefault, false );
				document.addEventListener( 'touchmove', preventDefault, false );
				document.addEventListener( 'touchend', preventDefault, false );
			}

			function preventDefault(event) {
				event.preventDefault(); 
			}
			
			function initSounds() {
				//burstSound = new Audio("sounds/burstsml2.aif");

				if(browser=="netscape")burstSound = new Audio("sounds/collectgold.ogg");
				else burstSound = new Audio("sounds/collectgold.mp3");	
				burstSound.load();
				// you have to play the sound to make sure it's loaded, otherwise you get 
				// a glitch the first time you play it
				burstSound.volume = 0; 
				burstSound.play(); 
			
			}
			
			function playBurst() { 
				var v = burstSound;
				v.currentTime = 0;
				v.volume = 1; 
			    v.play(); 
			}

			

			
			function detectOrientation(){
			    if(typeof window.onorientationchange != 'undefined' || typeof screen.onorientationchange != 'undefined'){
			        if ( orientation == 0 ) { //Do Something In Portrait Mode
				        info.innerHTML = "Portrait Mode 0";
			        }
			        else if ( orientation == 90 ) { //Do Something In Landscape Mode
				info.innerHTML = "Landscape Mode 90";
			        }
			        else if ( orientation == -90 ) { //Do Something In Landscape Mode
				info.innerHTML = "Landscape Mode -90";
			        }
			        else if ( orientation == 180 ) {  //Do Something In Landscape Mode
				info.innerHTML = "Portrait Mode 180";
			        }
			    }
			}

			if(typeof window.orientation !== 'undefined') window.onorientationchange = detectOrientation;
			if(typeof screen.orientation !== 'undefined') screen.onorientationchange  = detectOrientation;
			window.onload = init;

			var movewait
			var sizewait

			document.addEventListener('mousemove', function(e){
			    if(typeof movewait != 'undefined'){
			        clearTimeout(movewait);
			    }
			    movewait = setTimeout(function(){
			        info2.innerHTML = "mouse move " + e.clientX+"/"+e.clientY;
			    },17);
			}, false);

			window.addEventListener('resize', function(){
			    if(typeof sizewait != 'undefined'){
			        clearTimeout(sizewait);
			    }
			    sizewait = setTimeout(function(){
			        info2.innerHTML = "resize "+window.innerWidth+"/"+window.innerHeight;
			    },17);
			}, false);
/*
// collection of sounds that are playing
var playing={};
// collection of sounds
var sounds={step:"knock.ogg",throw:"swing.ogg"};

// function that is used to play sounds
function player(x)
{
    var a,b;
    b=new Date();
    a=x+b.getTime();
    playing[a]=new Audio(sounds[x]);
    // with this we prevent playing-object from becoming a memory-monster:
    playing[a].onended=function(){delete playing[a]};
    playing[a].play();
}
player("step");
*/
		</script>
	</body>
</html>
